{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}AI Sales Assistant - Admin Dashboard{% endblock %}

{% block extrahead %}
<style>
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        color: #0073aa;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .ai-panel {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .ai-panel-header {
        background: #0073aa;
        color: white;
        padding: 15px 20px;
        font-weight: bold;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .ai-panel-body {
        padding: 20px;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-healthy { background: #28a745; }
    .status-warning { background: #ffc107; }
    .status-error { background: #dc3545; }
    .status-unknown { background: #6c757d; }
    
    .ai-tools {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .ai-tool {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        background: #f8f9fa;
    }
    
    .ai-tool h3 {
        margin-top: 0;
        color: #0073aa;
    }
    
    .btn-ai {
        background: #0073aa;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin-right: 10px;
        margin-bottom: 10px;
    }
    
    .btn-ai:hover {
        background: #005a87;
        color: white;
    }
    
    .recent-activity {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .activity-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .activity-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-time {
        color: #666;
        font-size: 0.8em;
    }
    
    .health-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .health-fill {
        height: 100%;
        background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
        transition: width 0.3s ease;
    }
    
    .ai-form {
        margin-top: 15px;
    }
    
    .ai-form textarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: monospace;
    }
    
    .ai-results {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 4px solid #0073aa;
        display: none;
    }
    
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #666;
    }
    
    .spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #0073aa;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; align-items: center; margin-bottom: 30px;">
    <img src="{% static 'images/nia-logo-new.jpg' %}" alt="NIA Logo" style="height: 50px; width: auto; margin-right: 20px;">
    <h1 style="margin: 0; color: #333;">ü§ñ AI Sales Assistant - Admin Dashboard</h1>
</div>

<!-- Statistics Overview -->
<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-number">{{ total_leads }}</div>
        <div class="stat-label">Total Leads</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ active_integrations }}</div>
        <div class="stat-label">Active Integrations</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ total_templates }}</div>
        <div class="stat-label">Templates Available</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ active_workflows }}</div>
        <div class="stat-label">Active Workflows</div>
    </div>
</div>

<!-- AI Service Status -->
<div class="ai-panel">
    <div class="ai-panel-header">
        <span>üß† AI Service Status</span>
        <span class="status-indicator status-{{ ai_service_status.status }}"></span>
    </div>
    <div class="ai-panel-body">
        <p><strong>Status:</strong> {{ ai_service_status.message }}</p>
        <p><strong>Model:</strong> {{ ai_service_status.model }}</p>
        <button class="btn-ai" onclick="testAIConnection()">Test Connection</button>
        <div id="ai-connection-result" class="ai-results"></div>
    </div>
</div>

<!-- Integration Health -->
<div class="ai-panel">
    <div class="ai-panel-header">
        <span>üîó Integration Health</span>
        <span>{{ integration_health.health_percentage|floatformat:1 }}%</span>
    </div>
    <div class="ai-panel-body">
        <div class="health-bar">
            <div class="health-fill" style="width: {{ integration_health.health_percentage }}%"></div>
        </div>
        <p>
            <span style="color: #28a745;">‚óè {{ integration_health.healthy }} Healthy</span> |
            <span style="color: #ffc107;">‚óè {{ integration_health.warning }} Warning</span> |
            <span style="color: #dc3545;">‚óè {{ integration_health.error }} Error</span> |
            <span style="color: #6c757d;">‚óè {{ integration_health.unknown }} Unknown</span>
        </p>
        <a href="{% url 'admin:admin_config_integrationconfiguration_changelist' %}" class="btn-ai">Manage Integrations</a>
    </div>
</div>

<!-- AI Tools -->
<div class="ai-tools">
    <!-- Conversation Analysis -->
    <div class="ai-tool">
        <h3>üó£Ô∏è Conversation Analysis</h3>
        <p>Analyze conversation text to extract insights and recommendations.</p>
        <div class="ai-form">
            <textarea id="conversation-text" placeholder="Paste conversation text here..."></textarea>
            <br><br>
            <button class="btn-ai" onclick="analyzeConversation()">Analyze Conversation</button>
            <div class="loading" id="analyze-loading">
                <div class="spinner"></div>Analyzing...
            </div>
            <div id="analyze-results" class="ai-results"></div>
        </div>
    </div>
    
    <!-- Lead Information Extraction -->
    <div class="ai-tool">
        <h3>üìã Lead Information Extraction</h3>
        <p>Extract structured lead information from conversation text.</p>
        <div class="ai-form">
            <textarea id="extract-text" placeholder="Paste conversation text here..."></textarea>
            <br><br>
            <button class="btn-ai" onclick="extractLeadInfo()">Extract Lead Info</button>
            <button class="btn-ai" onclick="createLeadFromExtraction()" id="create-lead-btn" style="display: none;">Create Lead</button>
            <div class="loading" id="extract-loading">
                <div class="spinner"></div>Extracting...
            </div>
            <div id="extract-results" class="ai-results"></div>
        </div>
    </div>
    
    <!-- Lead Quality Scoring -->
    <div class="ai-tool">
        <h3>‚≠ê Lead Quality Scoring</h3>
        <p>Score lead quality based on extracted information.</p>
        <div class="ai-form">
            <textarea id="lead-data" placeholder='Enter lead data as JSON: {"company_name": "ABC Corp", "industry": "Technology", ...}'></textarea>
            <br><br>
            <button class="btn-ai" onclick="scoreLeadQuality()">Score Lead Quality</button>
            <div class="loading" id="score-loading">
                <div class="spinner"></div>Scoring...
            </div>
            <div id="score-results" class="ai-results"></div>
        </div>
    </div>
    
    <!-- Sales Strategy -->
    <div class="ai-tool">
        <h3>üéØ Sales Strategy</h3>
        <p>Generate AI-powered sales strategy recommendations.</p>
        <div class="ai-form">
            <textarea id="strategy-data" placeholder='Enter lead data as JSON: {"company_name": "ABC Corp", "industry": "Technology", ...}'></textarea>
            <br><br>
            <button class="btn-ai" onclick="generateSalesStrategy()">Generate Strategy</button>
            <div class="loading" id="strategy-loading">
                <div class="spinner"></div>Generating...
            </div>
            <div id="strategy-results" class="ai-results"></div>
        </div>
    </div>
    
    <!-- Comprehensive Recommendations -->
    <div class="ai-tool">
        <h3>üöÄ Comprehensive Recommendations</h3>
        <p>Get complete AI analysis with recommendations and next steps.</p>
        <div class="ai-form">
            <textarea id="recommendations-data" placeholder='Enter lead data as JSON: {"company_name": "ABC Corp", "industry": "Technology", ...}'></textarea>
            <br><br>
            <button class="btn-ai" onclick="getComprehensiveRecommendations()">Get Recommendations</button>
            <div class="loading" id="recommendations-loading">
                <div class="spinner"></div>Generating...
            </div>
            <div id="recommendations-results" class="ai-results"></div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="ai-tool">
        <h3>‚ö° Quick Actions</h3>
        <p>Quick access to common admin tasks.</p>
        <a href="/admin/ai_service/lead/" class="btn-ai">View All Leads</a>
        <a href="/admin/admin_config/configurationtemplate/" class="btn-ai">Manage Templates</a>
        <a href="/admin/admin_config/workflowconfiguration/" class="btn-ai">Manage Workflows</a>
        <a href="/admin/admin_config/configurationbackup/" class="btn-ai">View Backups</a>
        <a href="/admin/admin_config/configurationauditlog/" class="btn-ai">Audit Logs</a>
    </div>
</div>

<!-- Recent Activity -->
<div class="recent-activity">
    <div class="ai-panel">
        <div class="ai-panel-header">üìà Recent Leads</div>
        <div class="ai-panel-body">
            <ul class="activity-list">
                {% for lead in recent_leads %}
                <li class="activity-item">
                    <div>
                        <strong>{{ lead.company_name }}</strong><br>
                        <small>{{ lead.contact_info.name|default:"No contact" }}</small>
                    </div>
                    <div class="activity-time">{{ lead.created_at|timesince }} ago</div>
                </li>
                {% empty %}
                <li class="activity-item">No recent leads</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    
    <div class="ai-panel">
        <div class="ai-panel-header">üîß Recent Integrations</div>
        <div class="ai-panel-body">
            <ul class="activity-list">
                {% for integration in recent_integrations %}
                <li class="activity-item">
                    <div>
                        <strong>{{ integration.name }}</strong><br>
                        <small>{{ integration.get_integration_type_display }} - {{ integration.get_status_display }}</small>
                    </div>
                    <div class="activity-time">{{ integration.updated_at|timesince }} ago</div>
                </li>
                {% empty %}
                <li class="activity-item">No recent integrations</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    
    <div class="ai-panel">
        <div class="ai-panel-header">üß™ Recent Tests</div>
        <div class="ai-panel-body">
            <ul class="activity-list">
                {% for test in recent_tests %}
                <li class="activity-item">
                    <div>
                        <strong>{{ test.configuration.name }}</strong><br>
                        <small>{{ test.get_test_type_display }} - {{ test.get_status_display }}</small>
                    </div>
                    <div class="activity-time">{{ test.started_at|timesince }} ago</div>
                </li>
                {% empty %}
                <li class="activity-item">No recent tests</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<script>
// Global variables for storing extraction results
let lastExtractionResult = null;
let lastAnalysisResult = null;

// Test AI Connection
async function testAIConnection() {
    const resultDiv = document.getElementById('ai-connection-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<div class="spinner"></div> Testing connection...';
    
    try {
        const response = await fetch('/admin/ai/test-connection/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `
                <h4>‚úÖ Connection Test Successful</h4>
                <p><strong>Status:</strong> ${data.connection_test.message}</p>
                <p><strong>Model:</strong> ${data.connection_test.model}</p>
                <p><strong>Response:</strong> ${data.connection_test.response}</p>
            `;
        } else {
            resultDiv.innerHTML = `<h4>‚ùå Connection Test Failed</h4><p>${data.error}</p>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<h4>‚ùå Connection Test Failed</h4><p>Error: ${error.message}</p>`;
    }
}

// Analyze Conversation
async function analyzeConversation() {
    const text = document.getElementById('conversation-text').value;
    const loadingDiv = document.getElementById('analyze-loading');
    const resultDiv = document.getElementById('analyze-results');
    
    if (!text.trim()) {
        alert('Please enter conversation text to analyze');
        return;
    }
    
    loadingDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    
    try {
        const response = await fetch('/admin/ai/analyze-conversation/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                conversation_text: text,
                context: { source: 'admin_dashboard' }
            })
        });
        
        const data = await response.json();
        loadingDiv.style.display = 'none';
        
        if (data.success) {
            lastAnalysisResult = data.analysis;
            resultDiv.innerHTML = `
                <h4>üìä Analysis Results</h4>
                <p><strong>Summary:</strong> ${data.analysis.summary || 'Analysis completed'}</p>
                <p><strong>Key Points:</strong> ${data.analysis.key_points || 'See detailed analysis'}</p>
                <p><strong>Sentiment:</strong> ${data.analysis.sentiment || 'Neutral'}</p>
                <p><strong>Recommendations:</strong> ${data.analysis.recommendations || 'No specific recommendations'}</p>
            `;
            resultDiv.style.display = 'block';
        } else {
            resultDiv.innerHTML = `<h4>‚ùå Analysis Failed</h4><p>${data.error}</p>`;
            resultDiv.style.display = 'block';
        }
    } catch (error) {
        loadingDiv.style.display = 'none';
        resultDiv.innerHTML = `<h4>‚ùå Analysis Failed</h4><p>Error: ${error.message}</p>`;
        resultDiv.style.display = 'block';
    }
}

// Extract Lead Information
async function extractLeadInfo() {
    const text = document.getElementById('extract-text').value;
    const loadingDiv = document.getElementById('extract-loading');
    const resultDiv = document.getElementById('extract-results');
    const createBtn = document.getElementById('create-lead-btn');
    
    if (!text.trim()) {
        alert('Please enter conversation text to extract lead information');
        return;
    }
    
    loadingDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    createBtn.style.display = 'none';
    
    try {
        const response = await fetch('/admin/ai/extract-lead-info/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                conversation_text: text,
                context: { source: 'admin_dashboard' }
            })
        });
        
        const data = await response.json();
        loadingDiv.style.display = 'none';
        
        if (data.success) {
            lastExtractionResult = {
                conversation_text: text,
                extracted_info: data.extracted_info
            };
            
            resultDiv.innerHTML = `
                <h4>üìã Extracted Lead Information</h4>
                <p><strong>Company:</strong> ${data.extracted_info.company_name || 'Not detected'}</p>
                <p><strong>Contact Name:</strong> ${data.extracted_info.contact_name || 'Not detected'}</p>
                <p><strong>Email:</strong> ${data.extracted_info.contact_email || 'Not detected'}</p>
                <p><strong>Phone:</strong> ${data.extracted_info.contact_phone || 'Not detected'}</p>
                <p><strong>Industry:</strong> ${data.extracted_info.industry || 'Not detected'}</p>
                <p><strong>Requirements:</strong> ${data.extracted_info.requirements || 'Not specified'}</p>
            `;
            resultDiv.style.display = 'block';
            createBtn.style.display = 'inline-block';
        } else {
            resultDiv.innerHTML = `<h4>‚ùå Extraction Failed</h4><p>${data.error}</p>`;
            resultDiv.style.display = 'block';
        }
    } catch (error) {
        loadingDiv.style.display = 'none';
        resultDiv.innerHTML = `<h4>‚ùå Extraction Failed</h4><p>Error: ${error.message}</p>`;
        resultDiv.style.display = 'block';
    }
}

// Create Lead from Extraction
async function createLeadFromExtraction() {
    if (!lastExtractionResult) {
        alert('Please extract lead information first');
        return;
    }
    
    try {
        const response = await fetch('/admin/ai/create-lead/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                conversation_text: lastExtractionResult.conversation_text,
                extracted_info: lastExtractionResult.extracted_info,
                analysis_result: lastAnalysisResult
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úÖ ${data.message}\nLead ID: ${data.lead_id}`);
            // Optionally redirect to the lead in admin
            window.open(`/admin/ai_service/lead/${data.lead_id}/change/`, '_blank');
        } else {
            alert(`‚ùå Lead creation failed: ${data.error}`);
        }
    } catch (error) {
        alert(`‚ùå Lead creation failed: ${error.message}`);
    }
}

// Score Lead Quality
async function scoreLeadQuality() {
    const leadDataText = document.getElementById('lead-data').value;
    const loadingDiv = document.getElementById('score-loading');
    const resultDiv = document.getElementById('score-results');
    
    if (!leadDataText.trim()) {
        alert('Please enter lead data as JSON');
        return;
    }
    
    let leadData;
    try {
        leadData = JSON.parse(leadDataText);
    } catch (e) {
        alert('Invalid JSON format. Please check your lead data.');
        return;
    }
    
    loadingDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    
    try {
        const response = await fetch('/admin/ai/lead-quality-score/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ lead_data: leadData })
        });
        
        const data = await response.json();
        loadingDiv.style.display = 'none';
        
        if (data.success) {
            const score = data.quality_score;
            resultDiv.innerHTML = `
                <h4>‚≠ê Lead Quality Score</h4>
                <p><strong>Overall Score:</strong> ${score.overall_score || 'N/A'}/100</p>
                <p><strong>Quality Level:</strong> ${score.quality_level || 'Unknown'}</p>
                <p><strong>Factors:</strong> ${score.scoring_factors ? Object.keys(score.scoring_factors).join(', ') : 'N/A'}</p>
                <p><strong>Recommendations:</strong> ${score.recommendations || 'No specific recommendations'}</p>
            `;
            resultDiv.style.display = 'block';
        } else {
            resultDiv.innerHTML = `<h4>‚ùå Scoring Failed</h4><p>${data.error}</p>`;
            resultDiv.style.display = 'block';
        }
    } catch (error) {
        loadingDiv.style.display = 'none';
        resultDiv.innerHTML = `<h4>‚ùå Scoring Failed</h4><p>Error: ${error.message}</p>`;
        resultDiv.style.display = 'block';
    }
}

// Generate Sales Strategy
async function generateSalesStrategy() {
    const leadDataText = document.getElementById('strategy-data').value;
    const loadingDiv = document.getElementById('strategy-loading');
    const resultDiv = document.getElementById('strategy-results');
    
    if (!leadDataText.trim()) {
        alert('Please enter lead data as JSON');
        return;
    }
    
    let leadData;
    try {
        leadData = JSON.parse(leadDataText);
    } catch (e) {
        alert('Invalid JSON format. Please check your lead data.');
        return;
    }
    
    loadingDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    
    try {
        const response = await fetch('/admin/ai/sales-strategy/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ lead_data: leadData })
        });
        
        const data = await response.json();
        loadingDiv.style.display = 'none';
        
        if (data.success) {
            const strategy = data.sales_strategy;
            resultDiv.innerHTML = `
                <h4>üéØ Sales Strategy</h4>
                <p><strong>Approach:</strong> ${strategy.approach || 'Standard approach'}</p>
                <p><strong>Key Messages:</strong> ${strategy.key_messages || 'Focus on value proposition'}</p>
                <p><strong>Next Steps:</strong> ${strategy.next_steps || 'Follow up within 24 hours'}</p>
                <p><strong>Timeline:</strong> ${strategy.timeline || 'Standard sales cycle'}</p>
            `;
            resultDiv.style.display = 'block';
        } else {
            resultDiv.innerHTML = `<h4>‚ùå Strategy Generation Failed</h4><p>${data.error}</p>`;
            resultDiv.style.display = 'block';
        }
    } catch (error) {
        loadingDiv.style.display = 'none';
        resultDiv.innerHTML = `<h4>‚ùå Strategy Generation Failed</h4><p>Error: ${error.message}</p>`;
        resultDiv.style.display = 'block';
    }
}

// Get Comprehensive Recommendations
async function getComprehensiveRecommendations() {
    const leadDataText = document.getElementById('recommendations-data').value;
    const loadingDiv = document.getElementById('recommendations-loading');
    const resultDiv = document.getElementById('recommendations-results');
    
    if (!leadDataText.trim()) {
        alert('Please enter lead data as JSON');
        return;
    }
    
    let leadData;
    try {
        leadData = JSON.parse(leadDataText);
    } catch (e) {
        alert('Invalid JSON format. Please check your lead data.');
        return;
    }
    
    loadingDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    
    try {
        const response = await fetch('/admin/ai/comprehensive-recommendations/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ lead_data: leadData })
        });
        
        const data = await response.json();
        loadingDiv.style.display = 'none';
        
        if (data.success) {
            const recommendations = data.recommendations;
            resultDiv.innerHTML = `
                <h4>üöÄ Comprehensive Recommendations</h4>
                <p><strong>Priority Actions:</strong> ${recommendations.priority_actions || 'Standard follow-up'}</p>
                <p><strong>Communication Strategy:</strong> ${recommendations.communication_strategy || 'Professional approach'}</p>
                <p><strong>Value Proposition:</strong> ${recommendations.value_proposition || 'Highlight key benefits'}</p>
                <p><strong>Risk Factors:</strong> ${recommendations.risk_factors || 'Low risk'}</p>
                <p><strong>Success Probability:</strong> ${recommendations.success_probability || 'Moderate'}%</p>
            `;
            resultDiv.style.display = 'block';
        } else {
            resultDiv.innerHTML = `<h4>‚ùå Recommendations Generation Failed</h4><p>${data.error}</p>`;
            resultDiv.style.display = 'block';
        }
    } catch (error) {
        loadingDiv.style.display = 'none';
        resultDiv.innerHTML = `<h4>‚ùå Recommendations Generation Failed</h4><p>Error: ${error.message}</p>`;
        resultDiv.style.display = 'block';
    }
}

// Utility function to get CSRF token
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}
</script>
{% endblock %}